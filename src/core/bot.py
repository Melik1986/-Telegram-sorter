import logging
import asyncio
import os
import re
from typing import Optional, List, Dict, Any
from datetime import datetime, timedelta
from urllib.parse import urlparse

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes
from telegram.constants import ParseMode

from .classifier import ContentClassifier
from .config import get_ai_config, TELEGRAM_BOT_TOKEN
from ..utils.storage import ResourceStorage
from ..utils.rate_limiter import RateLimiter
from ..utils.i18n import I18nManager
from ..handlers.file_handler import FileHandler
from ..handlers.message_sorter import MessageSorter
from ..handlers.command_interpreter import NaturalLanguageCommandInterpreter, CommandType

logger = logging.getLogger(__name__)

class DevDataSorterBot:
    """Main bot class for DevDataSorter."""
    
    def __init__(self, token: str = None):
        self.token = token or TELEGRAM_BOT_TOKEN
        self.ai_config = get_ai_config()
        self.storage = ResourceStorage()
        self.classifier = ContentClassifier()
        self.rate_limiter = RateLimiter()
        self.i18n = I18nManager()
        self.file_handler = FileHandler()
        self.message_sorter = MessageSorter(self.classifier)
        self.command_interpreter = NaturalLanguageCommandInterpreter(self.classifier)
        
        # Initialize Telegram application
        self.app = Application.builder().token(self.token).build()
        
        # Add handlers
        self._setup_handlers()
    
    def _setup_handlers(self):
        """Setup all bot handlers."""
        # Command handlers
        self.app.add_handler(CommandHandler("start", self.start_command))
        self.app.add_handler(CommandHandler("help", self.help_command))
        self.app.add_handler(CommandHandler("list", self.list_command))
        self.app.add_handler(CommandHandler("search", self.search_command))
        self.app.add_handler(CommandHandler("stats", self.stats_command))
        self.app.add_handler(CommandHandler("export", self.export_command))
        self.app.add_handler(CommandHandler("settings", self.settings_command))
        self.app.add_handler(CommandHandler("analyze", self.analyze_command))
        self.app.add_handler(CommandHandler("delete", self.delete_command))
        self.app.add_handler(CommandHandler("archive", self.archive_command))
        
        # Message handlers
        self.app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
        self.app.add_handler(MessageHandler(filters.Document.ALL, self.handle_file))
        self.app.add_handler(MessageHandler(filters.PHOTO, self.handle_photo))
        self.app.add_handler(MessageHandler(filters.VIDEO, self.handle_video))
        self.app.add_handler(MessageHandler(filters.AUDIO, self.handle_audio))
        
        # Callback query handler
        self.app.add_handler(CallbackQueryHandler(self.handle_callback))
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle incoming text messages."""
        user_id = update.effective_user.id
        content = update.message.text
        
        # Rate limiting
        if not self.rate_limiter.is_allowed(user_id):
            await update.message.reply_text(
                "‚è∞ Too many requests. Please wait a moment.\n"
                "‚è∞ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ."
            )
            return
        
        # First, try to interpret as a natural language command
        command_intent = await self.command_interpreter.interpret_command(content)
        
        if command_intent.command_type != CommandType.UNKNOWN and command_intent.confidence > 0.6:
            await self._handle_command_intent(update, context, command_intent)
            return
        
        # Determine if this is a question/request or content to classify
        if await self._is_question_or_request(content):
            await self._handle_intelligent_response(update, context, content)
        else:
            await self._process_content(update, context, content)
    
    async def _handle_command_intent(self, update: Update, context: ContextTypes.DEFAULT_TYPE, command_intent):
        """Handle interpreted natural language commands."""
        try:
            command_type = command_intent.command_type
            parameters = command_intent.parameters
            language = command_intent.language
            
            # Show processing message
            if language == 'ru':
                status_msg = await update.message.reply_text("ü§ñ –í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É...")
            else:
                status_msg = await update.message.reply_text("ü§ñ Executing command...")
            
            if command_type == CommandType.SEARCH:
                query = parameters.get('query', '')
                if query:
                    await self._execute_search_command(update, context, query, language)
                else:
                    await self._send_search_help(update, language)
            
            elif command_type == CommandType.CREATE_FOLDER:
                folder_name = parameters.get('name', '')
                if folder_name:
                    await self._execute_create_folder_command(update, context, folder_name, language)
                else:
                    await self._send_folder_help(update, language)
            
            elif command_type == CommandType.CREATE_ARCHIVE:
                archive_name = parameters.get('name', '')
                if archive_name:
                    await self._execute_create_archive_command(update, context, archive_name, language)
                else:
                    await self._send_archive_help(update, language)
            
            elif command_type == CommandType.LIST:
                category = parameters.get('category', 'all')
                await self._execute_list_command(update, context, category, language)
            
            elif command_type == CommandType.HELP:
                await self._execute_help_command(update, context, language)
            
            elif command_type == CommandType.STATS:
                await self._execute_stats_command(update, context, language)
            
            elif command_type == CommandType.EXPORT:
                format_type = parameters.get('format', 'json')
                await self._execute_export_command(update, context, format_type, language)
            
            elif command_type == CommandType.ANALYZE:
                await self._execute_analyze_command(update, context, language)
            
            elif command_type == CommandType.DELETE:
                item_id = parameters.get('id')
                if item_id:
                    await self._execute_delete_command(update, context, item_id, language)
                else:
                    await self._send_delete_help(update, language)
            
            # Delete status message
            try:
                await status_msg.delete()
            except:
                pass
                
        except Exception as e:
            logger.error(f"Error handling command intent: {e}")
            error_msg = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã" if command_intent.language == 'ru' else "‚ùå Error executing command"
            await update.message.reply_text(error_msg)
    
    # Command execution methods
    async def _execute_search_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, query: str, language: str):
        """Execute search command."""
        try:
            results = await self.storage.search_resources(query)
            
            if not results:
                if language == 'ru':
                    response = f"üîç –ü–æ –∑–∞–ø—Ä–æ—Å—É '{query}' –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                else:
                    response = f"üîç No results found for '{query}'"
            else:
                if language == 'ru':
                    response = f"üîç –ù–∞–π–¥–µ–Ω–æ {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{query}':\n\n"
                else:
                    response = f"üîç Found {len(results)} results for '{query}':\n\n"
                
                for i, result in enumerate(results[:10], 1):
                    response += f"{i}. {result.get('title', 'Untitled')}\n"
                    response += f"   üìÅ {result.get('category', 'Unknown')}\n"
                    if result.get('description'):
                        response += f"   üìù {result['description'][:100]}...\n"
                    response += "\n"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Search command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞" if language == 'ru' else "‚ùå Search error"
            await update.message.reply_text(error_msg)
    
    async def _execute_create_folder_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, folder_name: str, language: str):
        """Execute create folder command."""
        try:
            # Create folder logic here
            if language == 'ru':
                response = f"üìÅ –ü–∞–ø–∫–∞ '{folder_name}' —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
            else:
                response = f"üìÅ Folder '{folder_name}' created successfully"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Create folder error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏" if language == 'ru' else "‚ùå Folder creation error"
            await update.message.reply_text(error_msg)
    
    async def _execute_create_archive_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, archive_name: str, language: str):
        """Execute create archive command."""
        try:
            # Create archive logic here
            if language == 'ru':
                response = f"üì¶ –ê—Ä—Ö–∏–≤ '{archive_name}' —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
            else:
                response = f"üì¶ Archive '{archive_name}' created successfully"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Create archive error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞" if language == 'ru' else "‚ùå Archive creation error"
            await update.message.reply_text(error_msg)
    
    async def _execute_list_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, category: str, language: str):
        """Execute list command."""
        try:
            resources = await self.storage.get_resources_by_category(category)
            
            if not resources:
                if language == 'ru':
                    response = f"üìã –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{category}' –Ω–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤"
                else:
                    response = f"üìã No resources in category '{category}'"
            else:
                if language == 'ru':
                    response = f"üìã –†–µ—Å—É—Ä—Å—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{category}' ({len(resources)}):\n\n"
                else:
                    response = f"üìã Resources in category '{category}' ({len(resources)}):\n\n"
                
                for i, resource in enumerate(resources[:20], 1):
                    response += f"{i}. {resource.get('title', 'Untitled')}\n"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"List command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞" if language == 'ru' else "‚ùå List error"
            await update.message.reply_text(error_msg)
    
    async def _execute_help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, language: str):
        """Execute help command."""
        if language == 'ru':
            response = """ü§ñ –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:

üîç –ü–æ–∏—Å–∫: "–Ω–∞–π–¥–∏ –∫–æ–¥ Python" –∏–ª–∏ "–ø–æ–∏—Å–∫ –ø–æ React"
üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏: "—Å–æ–∑–¥–∞–π –ø–∞–ø–∫—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤"
üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: "—Å–æ–∑–¥–∞–π –∞—Ä—Ö–∏–≤ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"
üìã –°–ø–∏—Å–æ–∫: "–ø–æ–∫–∞–∂–∏ –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã" –∏–ª–∏ "—Å–ø–∏—Å–æ–∫ –∫–æ–¥–∞"
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: "–ø–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
üì§ –≠–∫—Å–ø–æ—Ä—Ç: "—ç–∫—Å–ø–æ—Ä—Ç –≤ JSON"
üî¨ –ê–Ω–∞–ª–∏–∑: "–∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö"
üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ: "—É–¥–∞–ª–∏ —Ä–µ—Å—É—Ä—Å 123"

–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º!"""
        else:
            response = """ü§ñ Command Help:

üîç Search: "find Python code" or "search React"
üìÅ Create folder: "create folder for projects"
üì¶ Create archive: "create archive for old files"
üìã List: "show all resources" or "list code"
üìä Statistics: "show statistics"
üì§ Export: "export to JSON"
üî¨ Analysis: "analyze data"
üóëÔ∏è Delete: "delete resource 123"

Just write commands in natural language!"""
        
        await update.message.reply_text(response)
    
    async def _execute_stats_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, language: str):
        """Execute statistics command."""
        try:
            stats = await self.storage.get_statistics()
            
            if language == 'ru':
                response = f"""üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

üìÅ –í—Å–µ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤: {stats.get('total', 0)}
üîó –°—Å—ã–ª–∫–∏: {stats.get('links', 0)}
üìù –ó–∞–º–µ—Ç–∫–∏: {stats.get('notes', 0)}
üíª –ö–æ–¥: {stats.get('code', 0)}
üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã: {stats.get('documents', 0)}
üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {stats.get('images', 0)}"""
            else:
                response = f"""üìä Statistics:

üìÅ Total resources: {stats.get('total', 0)}
üîó Links: {stats.get('links', 0)}
üìù Notes: {stats.get('notes', 0)}
üíª Code: {stats.get('code', 0)}
üìÑ Documents: {stats.get('documents', 0)}
üñºÔ∏è Images: {stats.get('images', 0)}"""
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Stats command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏" if language == 'ru' else "‚ùå Statistics error"
            await update.message.reply_text(error_msg)
    
    async def _execute_export_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, format_type: str, language: str):
        """Execute export command."""
        try:
            # Export logic here
            if language == 'ru':
                response = f"üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ {format_type} –Ω–∞—á–∞—Ç"
            else:
                response = f"üì§ Export in {format_type} format started"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Export command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞" if language == 'ru' else "‚ùå Export error"
            await update.message.reply_text(error_msg)
    
    async def _execute_analyze_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, language: str):
        """Execute analysis command."""
        try:
            # Analysis logic here
            if language == 'ru':
                response = "üî¨ –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω"
            else:
                response = "üî¨ Data analysis started"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Analysis command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞" if language == 'ru' else "‚ùå Analysis error"
            await update.message.reply_text(error_msg)
    
    async def _execute_delete_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE, item_id: str, language: str):
        """Execute delete command."""
        try:
            # Delete logic here
            if language == 'ru':
                response = f"üóëÔ∏è –†–µ—Å—É—Ä—Å {item_id} —É–¥–∞–ª–µ–Ω"
            else:
                response = f"üóëÔ∏è Resource {item_id} deleted"
            
            await update.message.reply_text(response)
            
        except Exception as e:
            logger.error(f"Delete command error: {e}")
            error_msg = "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è" if language == 'ru' else "‚ùå Delete error"
            await update.message.reply_text(error_msg)
    
    # Help methods
    async def _send_search_help(self, update: Update, language: str):
        """Send search help message."""
        if language == 'ru':
            response = "üîç –£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏—Å–∫–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: '–Ω–∞–π–¥–∏ –∫–æ–¥ –Ω–∞ Python'"
        else:
            response = "üîç Please specify what to search for. Example: 'find Python code'"
        await update.message.reply_text(response)
    
    async def _send_folder_help(self, update: Update, language: str):
        """Send folder creation help message."""
        if language == 'ru':
            response = "üìÅ –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: '—Å–æ–∑–¥–∞–π –ø–∞–ø–∫—É –¥–ª—è React –ø—Ä–æ–µ–∫—Ç–æ–≤'"
        else:
            response = "üìÅ Please specify folder name. Example: 'create folder for React projects'"
        await update.message.reply_text(response)
    
    async def _send_archive_help(self, update: Update, language: str):
        """Send archive creation help message."""
        if language == 'ru':
            response = "üì¶ –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: '—Å–æ–∑–¥–∞–π –∞—Ä—Ö–∏–≤ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤'"
        else:
            response = "üì¶ Please specify archive name. Example: 'create archive for old projects'"
        await update.message.reply_text(response)
    
    async def _send_delete_help(self, update: Update, language: str):
        """Send delete help message."""
        if language == 'ru':
            response = "üóëÔ∏è –£–∫–∞–∂–∏—Ç–µ ID —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è. –ù–∞–ø—Ä–∏–º–µ—Ä: '—É–¥–∞–ª–∏ —Ä–µ—Å—É—Ä—Å 123'"
        else:
            response = "üóëÔ∏è Please specify resource ID to delete. Example: 'delete resource 123'"
        await update.message.reply_text(response)
    
    # Other existing methods would go here...
    # (start_command, help_command, etc.)