{% extends "base.html" %}

{% block title %}Главная - DevDataSorter{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body text-center py-5">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-folder-open me-3"></i>
                    DevDataSorter
                </h1>
                <p class="lead mb-4">
                    Интеллектуальная система организации и поиска данных разработчика
                </p>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <span class="badge badge-custom fs-6">
                                <i class="fas fa-search me-1"></i>
                                Семантический поиск
                            </span>
                            <span class="badge badge-custom fs-6">
                                <i class="fas fa-tags me-1"></i>
                                Автоматическая классификация
                            </span>
                            <span class="badge badge-custom fs-6">
                                <i class="fas fa-brain me-1"></i>
                                ИИ-анализ
                            </span>
                            <span class="badge badge-custom fs-6">
                                <i class="fas fa-chart-bar me-1"></i>
                                Аналитика
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Search -->
<div class="row mb-5">
    <div class="col-12">
        <div class="search-container">
            <h3 class="text-center mb-4">
                <i class="fas fa-search me-2 text-primary"></i>
                Быстрый поиск
            </h3>
            
            <form id="quickSearchForm">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="searchQuery" 
                                   placeholder="Введите запрос: 'React компоненты', 'Python скрипты', 'найди все туториалы'..."
                                   autocomplete="off">
                        </div>
                        
                        <!-- Suggestions dropdown -->
                        <div id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>
                                Найти
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Search Options -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="semanticSearch" checked>
                                <label class="form-check-label" for="semanticSearch">
                                    <i class="fas fa-brain me-1"></i>
                                    Семантический поиск
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="metadataSearch" checked>
                                <label class="form-check-label" for="metadataSearch">
                                    <i class="fas fa-tags me-1"></i>
                                    По метаданным
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="naturalCommands" checked>
                                <label class="form-check-label" for="naturalCommands">
                                    <i class="fas fa-comments me-1"></i>
                                    Естественные команды
                                </label>
                            </div>
                            
                            <select class="form-select" id="searchCategory" style="width: auto;">
                                <option value="">Все категории</option>
                                <option value="code">Код</option>
                                <option value="documentation">Документация</option>
                                <option value="tutorial">Туториалы</option>
                                <option value="reference">Справочники</option>
                                <option value="project">Проекты</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Loading indicator -->
            <div id="searchLoading" class="loading text-center">
                <div class="spinner"></div>
                <p class="mt-2">Поиск...</p>
            </div>
            
            <!-- Quick results -->
            <div id="quickResults" class="mt-4" style="display: none;">
                <h5 class="mb-3">
                    <i class="fas fa-list me-2"></i>
                    Результаты поиска
                </h5>
                <div id="resultsContainer"></div>
                <div class="text-center mt-3">
                    <a href="{{ url_for('search_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-right me-2"></i>
                        Расширенный поиск
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-5">
    <div class="col-12">
        <h3 class="text-center mb-4">
            <i class="fas fa-bolt me-2 text-warning"></i>
            Быстрые действия
        </h3>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-folder-plus fa-3x text-primary"></i>
                </div>
                <h5 class="card-title">Сканировать папку</h5>
                <p class="card-text">Добавить новую папку для анализа и классификации</p>
                <button class="btn btn-primary" onclick="scanFolder()">
                    <i class="fas fa-plus me-2"></i>
                    Сканировать
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-sync-alt fa-3x text-success"></i>
                </div>
                <h5 class="card-title">Обновить индекс</h5>
                <p class="card-text">Переиндексировать все файлы и обновить метаданные</p>
                <button class="btn btn-success" onclick="updateIndex()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Обновить
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-download fa-3x text-info"></i>
                </div>
                <h5 class="card-title">Экспорт данных</h5>
                <p class="card-text">Экспортировать результаты классификации</p>
                <button class="btn btn-info" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>
                    Экспорт
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card h-100 text-center">
            <div class="card-body">
                <div class="mb-3">
                    <i class="fas fa-chart-line fa-3x text-warning"></i>
                </div>
                <h5 class="card-title">Аналитика</h5>
                <p class="card-text">Просмотреть статистику и аналитику</p>
                <a href="{{ url_for('dashboard') }}" class="btn btn-warning">
                    <i class="fas fa-chart-bar me-2"></i>
                    Открыть
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mb-5">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Последняя активность
                </h5>
            </div>
            <div class="card-body">
                <div id="recentActivity">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Загрузка активности...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Статистика
                </h5>
            </div>
            <div class="card-body">
                <div id="quickStats">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Загрузка статистики...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tips Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Советы по использованию
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-search me-2 text-primary"></i>Поиск</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Используйте естественные запросы: "найди React компоненты"</li>
                            <li><i class="fas fa-check text-success me-2"></i>Ищите по содержимому: "функции для работы с API"</li>
                            <li><i class="fas fa-check text-success me-2"></i>Фильтруйте по датам: "файлы за последний месяц"</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-tags me-2 text-info"></i>Организация</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Система автоматически классифицирует файлы</li>
                            <li><i class="fas fa-check text-success me-2"></i>Добавляйте собственные теги и метаданные</li>
                            <li><i class="fas fa-check text-success me-2"></i>Используйте дашборд для анализа структуры</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Поиск и автодополнение
let searchTimeout;
let suggestionsCache = new Map();

// Инициализация
$(document).ready(function() {
    loadQuickStats();
    loadRecentActivity();
    initializeSearch();
});

// Инициализация поиска
function initializeSearch() {
    const searchInput = $('#searchQuery');
    const suggestionsDiv = $('#suggestions');
    
    // Автодополнение
    searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            suggestionsDiv.hide().empty();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            getSuggestions(query);
        }, 300);
    });
    
    // Скрытие подсказок при клике вне
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.search-container').length) {
            suggestionsDiv.hide();
        }
    });
    
    // Обработка формы поиска
    $('#quickSearchForm').on('submit', function(e) {
        e.preventDefault();
        performQuickSearch();
    });
}

// Получение подсказок
async function getSuggestions(query) {
    if (suggestionsCache.has(query)) {
        showSuggestions(suggestionsCache.get(query));
        return;
    }
    
    try {
        const response = await apiCall('/api/suggestions', {
            method: 'POST',
            body: JSON.stringify({ query: query })
        });
        
        suggestionsCache.set(query, response.suggestions);
        showSuggestions(response.suggestions);
    } catch (error) {
        console.error('Error getting suggestions:', error);
    }
}

// Отображение подсказок
function showSuggestions(suggestions) {
    const suggestionsDiv = $('#suggestions');
    suggestionsDiv.empty();
    
    if (suggestions.length === 0) {
        suggestionsDiv.hide();
        return;
    }
    
    suggestions.forEach(suggestion => {
        const item = $(`
            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="fas fa-${suggestion.icon || 'search'} me-2 text-muted"></i>
                <span>${suggestion.text}</span>
                ${suggestion.type ? `<span class="badge bg-secondary ms-auto">${suggestion.type}</span>` : ''}
            </button>
        `);
        
        item.on('click', function() {
            $('#searchQuery').val(suggestion.text);
            suggestionsDiv.hide();
            performQuickSearch();
        });
        
        suggestionsDiv.append(item);
    });
    
    suggestionsDiv.show();
}

// Выполнение быстрого поиска
async function performQuickSearch() {
    const query = $('#searchQuery').val().trim();
    
    if (!query) {
        showAlert('Введите поисковый запрос', 'warning');
        return;
    }
    
    const searchOptions = {
        semantic: $('#semanticSearch').is(':checked'),
        metadata: $('#metadataSearch').is(':checked'),
        natural_commands: $('#naturalCommands').is(':checked'),
        category: $('#searchCategory').val()
    };
    
    showLoading('#searchLoading');
    $('#quickResults').hide();
    
    try {
        const response = await apiCall('/api/search', {
            method: 'POST',
            body: JSON.stringify({
                query: query,
                options: searchOptions,
                limit: 5
            })
        });
        
        displayQuickResults(response);
    } catch (error) {
        console.error('Search error:', error);
        showAlert('Ошибка при выполнении поиска', 'danger');
    } finally {
        hideLoading('#searchLoading');
    }
}

// Отображение результатов поиска
function displayQuickResults(response) {
    const container = $('#resultsContainer');
    container.empty();
    
    if (!response.results || response.results.length === 0) {
        container.html(`
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">Результаты не найдены</p>
            </div>
        `);
    } else {
        response.results.forEach(result => {
            const resultHtml = createResultItem(result);
            container.append(resultHtml);
        });
    }
    
    $('#quickResults').show();
}

// Создание элемента результата
function createResultItem(result) {
    const categoryIcon = {
        'code': 'code',
        'documentation': 'book',
        'tutorial': 'graduation-cap',
        'reference': 'bookmark',
        'project': 'folder',
        'other': 'file'
    };
    
    return $(`
        <div class="result-item">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    <i class="fas fa-${categoryIcon[result.category] || 'file'} fa-2x text-primary"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">
                        <a href="#" class="text-decoration-none" onclick="openFile('${result.path}')">
                            ${result.title || result.name}
                        </a>
                    </h6>
                    <p class="text-muted mb-2 small">${result.path}</p>
                    ${result.description ? `<p class="mb-2">${result.description}</p>` : ''}
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="badge bg-primary">${result.category}</span>
                        ${result.tags ? result.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join('') : ''}
                        <small class="text-muted ms-auto">
                            <i class="fas fa-clock me-1"></i>
                            ${formatDate(result.modified_date)}
                        </small>
                    </div>
                </div>
                <div class="ms-3">
                    <span class="badge bg-success">${Math.round(result.score * 100)}%</span>
                </div>
            </div>
        </div>
    `);
}

// Загрузка быстрой статистики
async function loadQuickStats() {
    try {
        const response = await apiCall('/api/stats');
        
        const statsHtml = `
            <div class="row text-center">
                <div class="col-6 mb-3">
                    <div class="stats-number text-primary">${response.total_files || 0}</div>
                    <div class="stats-label">Файлов</div>
                </div>
                <div class="col-6 mb-3">
                    <div class="stats-number text-success">${response.total_categories || 0}</div>
                    <div class="stats-label">Категорий</div>
                </div>
                <div class="col-6">
                    <div class="stats-number text-info">${formatFileSize(response.total_size || 0)}</div>
                    <div class="stats-label">Размер</div>
                </div>
                <div class="col-6">
                    <div class="stats-number text-warning">${response.indexed_files || 0}</div>
                    <div class="stats-label">Индексировано</div>
                </div>
            </div>
        `;
        
        $('#quickStats').html(statsHtml);
    } catch (error) {
        console.error('Error loading stats:', error);
        $('#quickStats').html('<p class="text-muted text-center">Ошибка загрузки статистики</p>');
    }
}

// Загрузка последней активности
async function loadRecentActivity() {
    try {
        const response = await apiCall('/api/recent-activity');
        
        if (!response.activities || response.activities.length === 0) {
            $('#recentActivity').html('<p class="text-muted text-center">Нет недавней активности</p>');
            return;
        }
        
        const activitiesHtml = response.activities.map(activity => `
            <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                <div class="me-3">
                    <i class="fas fa-${activity.icon || 'info-circle'} text-${activity.type || 'primary'}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold">${activity.title}</div>
                    <small class="text-muted">${activity.description}</small>
                </div>
                <div class="text-end">
                    <small class="text-muted">${formatDate(activity.timestamp)}</small>
                </div>
            </div>
        `).join('');
        
        $('#recentActivity').html(activitiesHtml);
    } catch (error) {
        console.error('Error loading recent activity:', error);
        $('#recentActivity').html('<p class="text-muted text-center">Ошибка загрузки активности</p>');
    }
}

// Быстрые действия
function scanFolder() {
    // TODO: Реализовать диалог выбора папки
    showAlert('Функция сканирования папки будет реализована', 'info');
}

function updateIndex() {
    if (confirm('Обновить индекс? Это может занять некоторое время.')) {
        // TODO: Реализовать обновление индекса
        showAlert('Обновление индекса запущено', 'success');
    }
}

function exportData() {
    // TODO: Реализовать экспорт данных
    showAlert('Функция экспорта будет реализована', 'info');
}

function openFile(path) {
    // TODO: Реализовать открытие файла
    console.log('Opening file:', path);
    showAlert(`Открытие файла: ${path}`, 'info');
}
</script>
{% endblock %}