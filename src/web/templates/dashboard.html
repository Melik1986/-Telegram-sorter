{% extends "base.html" %}

{% block title %}Дашборд - DevDataSorter{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-chart-bar me-2 text-primary"></i>
                    Дашборд аналитики
                </h2>
                <p class="text-muted mb-0">Обзор структуры данных и статистика классификации</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Обновить
                </button>
                <button class="btn btn-primary" onclick="exportReport()">
                    <i class="fas fa-download me-2"></i>
                    Экспорт отчета
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="totalFiles">-</div>
                    <div class="stats-label">Всего файлов</div>
                </div>
                <div>
                    <i class="fas fa-file fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="totalSize">-</div>
                    <div class="stats-label">Общий размер</div>
                </div>
                <div>
                    <i class="fas fa-hdd fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="totalCategories">-</div>
                    <div class="stats-label">Категорий</div>
                </div>
                <div>
                    <i class="fas fa-tags fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number" id="indexedFiles">-</div>
                    <div class="stats-label">Индексировано</div>
                </div>
                <div>
                    <i class="fas fa-search fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="fas fa-pie-chart me-2 text-primary"></i>
                Распределение по категориям
            </h5>
            <div id="categoryChart" style="height: 400px;"></div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="fas fa-chart-bar me-2 text-success"></i>
                Размеры файлов
            </h5>
            <div id="sizeChart" style="height: 400px;"></div>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="fas fa-chart-line me-2 text-info"></i>
                Активность по времени
            </h5>
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-sm btn-outline-primary active" data-period="week">Неделя</button>
                <button class="btn btn-sm btn-outline-primary" data-period="month">Месяц</button>
                <button class="btn btn-sm btn-outline-primary" data-period="year">Год</button>
            </div>
            <div id="timelineChart" style="height: 400px;"></div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="fas fa-code me-2 text-warning"></i>
                Языки программирования
            </h5>
            <div id="languageChart" style="height: 400px;"></div>
        </div>
    </div>
</div>

<!-- Folder Structure -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-folder-tree me-2"></i>
                    Структура папок
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="expandAll()">
                        <i class="fas fa-expand-alt me-1"></i>
                        Развернуть все
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                        <i class="fas fa-compress-alt me-1"></i>
                        Свернуть все
                    </button>
                    <div class="ms-auto">
                        <input type="text" class="form-control form-control-sm" placeholder="Поиск в структуре..." id="folderSearch">
                    </div>
                </div>
                <div id="folderStructure" class="folder-tree" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Загрузка структуры...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Топ категории
                </h5>
            </div>
            <div class="card-body">
                <div id="topCategories">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Проблемы
                </h5>
            </div>
            <div class="card-body">
                <div id="issues">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Проверка...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Changes -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Последние изменения
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="changesFilter" style="width: auto;">
                            <option value="all">Все изменения</option>
                            <option value="added">Добавленные</option>
                            <option value="modified">Измененные</option>
                            <option value="deleted">Удаленные</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentChanges()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="recentChanges">
                    <div class="text-center py-4">
                        <div class="spinner"></div>
                        <p class="mt-2">Загрузка изменений...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Глобальные переменные
let dashboardData = {};
let charts = {};

// Инициализация дашборда
$(document).ready(function() {
    loadDashboardData();
    initializeEventHandlers();
});

// Инициализация обработчиков событий
function initializeEventHandlers() {
    // Переключение периодов для временной диаграммы
    $('[data-period]').on('click', function() {
        $('[data-period]').removeClass('active');
        $(this).addClass('active');
        const period = $(this).data('period');
        updateTimelineChart(period);
    });
    
    // Фильтр изменений
    $('#changesFilter').on('change', function() {
        loadRecentChanges();
    });
    
    // Поиск в структуре папок
    $('#folderSearch').on('input', function() {
        const query = $(this).val().toLowerCase();
        filterFolderStructure(query);
    });
}

// Загрузка данных дашборда
async function loadDashboardData() {
    try {
        showLoading('.stats-card');
        
        const response = await apiCall('/api/dashboard-stats');
        dashboardData = response;
        
        updateStatsCards(response);
        createCharts(response);
        loadFolderStructure();
        loadTopCategories();
        loadIssues();
        loadRecentChanges();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showAlert('Ошибка загрузки данных дашборда', 'danger');
    }
}

// Обновление карточек статистики
function updateStatsCards(data) {
    $('#totalFiles').text(data.total_files || 0);
    $('#totalSize').text(formatFileSize(data.total_size || 0));
    $('#totalCategories').text(data.total_categories || 0);
    $('#indexedFiles').text(data.indexed_files || 0);
}

// Создание диаграмм
function createCharts(data) {
    createCategoryChart(data.category_distribution);
    createSizeChart(data.size_distribution);
    createTimelineChart(data.timeline_data);
    createLanguageChart(data.language_distribution);
}

// Диаграмма категорий
function createCategoryChart(data) {
    const chartData = [{
        values: Object.values(data || {}),
        labels: Object.keys(data || {}),
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c']
        },
        textinfo: 'label+percent',
        textposition: 'outside'
    }];
    
    const layout = {
        showlegend: true,
        margin: { t: 20, b: 20, l: 20, r: 20 },
        font: { size: 12 }
    };
    
    Plotly.newPlot('categoryChart', chartData, layout, { responsive: true });
    charts.category = true;
}

// Диаграмма размеров
function createSizeChart(data) {
    const chartData = [{
        x: Object.keys(data || {}),
        y: Object.values(data || {}),
        type: 'bar',
        marker: {
            color: '#3498db',
            opacity: 0.8
        }
    }];
    
    const layout = {
        title: '',
        xaxis: { title: 'Размер файла' },
        yaxis: { title: 'Количество файлов' },
        margin: { t: 20, b: 60, l: 60, r: 20 }
    };
    
    Plotly.newPlot('sizeChart', chartData, layout, { responsive: true });
    charts.size = true;
}

// Временная диаграмма
function createTimelineChart(data, period = 'week') {
    const timelineData = data?.[period] || {};
    
    const chartData = [{
        x: Object.keys(timelineData),
        y: Object.values(timelineData),
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: '#2ecc71',
            width: 3
        },
        marker: {
            color: '#27ae60',
            size: 8
        }
    }];
    
    const layout = {
        title: '',
        xaxis: { title: 'Время' },
        yaxis: { title: 'Количество файлов' },
        margin: { t: 20, b: 60, l: 60, r: 20 }
    };
    
    Plotly.newPlot('timelineChart', chartData, layout, { responsive: true });
    charts.timeline = true;
}

// Диаграмма языков
function createLanguageChart(data) {
    const chartData = [{
        x: Object.values(data || {}),
        y: Object.keys(data || {}),
        type: 'bar',
        orientation: 'h',
        marker: {
            color: '#f39c12',
            opacity: 0.8
        }
    }];
    
    const layout = {
        title: '',
        xaxis: { title: 'Количество файлов' },
        margin: { t: 20, b: 20, l: 100, r: 20 }
    };
    
    Plotly.newPlot('languageChart', chartData, layout, { responsive: true });
    charts.language = true;
}

// Обновление временной диаграммы
function updateTimelineChart(period) {
    if (dashboardData.timeline_data) {
        createTimelineChart(dashboardData.timeline_data, period);
    }
}

// Загрузка структуры папок
async function loadFolderStructure() {
    try {
        const response = await apiCall('/api/folder-structure');
        displayFolderStructure(response.structure);
    } catch (error) {
        console.error('Error loading folder structure:', error);
        $('#folderStructure').html('<p class="text-muted text-center">Ошибка загрузки структуры</p>');
    }
}

// Отображение структуры папок
function displayFolderStructure(structure, level = 0) {
    if (level === 0) {
        $('#folderStructure').empty();
    }
    
    const container = level === 0 ? $('#folderStructure') : null;
    let html = '';
    
    Object.entries(structure).forEach(([name, item]) => {
        const indent = '  '.repeat(level);
        const isFolder = item.type === 'folder';
        const icon = isFolder ? 'folder' : 'file';
        const className = isFolder ? 'folder' : 'file';
        
        html += `
            <div class="folder-item ${className}" style="padding-left: ${level * 20}px;" data-name="${name.toLowerCase()}">
                <i class="fas fa-${icon} me-2"></i>
                <span>${name}</span>
                ${isFolder ? `<span class="badge bg-secondary ms-2">${item.count || 0}</span>` : ''}
                ${item.size ? `<small class="text-muted ms-auto">${formatFileSize(item.size)}</small>` : ''}
            </div>
        `;
        
        if (isFolder && item.children) {
            html += displayFolderStructure(item.children, level + 1);
        }
    });
    
    if (container) {
        container.html(html);
    }
    
    return html;
}

// Фильтрация структуры папок
function filterFolderStructure(query) {
    const items = $('.folder-item');
    
    if (!query) {
        items.show();
        return;
    }
    
    items.each(function() {
        const name = $(this).data('name');
        if (name.includes(query)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Развернуть/свернуть все папки
function expandAll() {
    $('.folder-item.folder').addClass('expanded');
}

function collapseAll() {
    $('.folder-item.folder').removeClass('expanded');
}

// Загрузка топ категорий
async function loadTopCategories() {
    try {
        const response = await apiCall('/api/top-categories');
        
        const html = response.categories.map((category, index) => `
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <span class="badge bg-primary rounded-circle">${index + 1}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold">${category.name}</div>
                    <small class="text-muted">${category.count} файлов</small>
                </div>
                <div class="text-end">
                    <div class="progress" style="width: 60px; height: 8px;">
                        <div class="progress-bar" style="width: ${category.percentage}%"></div>
                    </div>
                </div>
            </div>
        `).join('');
        
        $('#topCategories').html(html);
    } catch (error) {
        console.error('Error loading top categories:', error);
        $('#topCategories').html('<p class="text-muted text-center">Ошибка загрузки</p>');
    }
}

// Загрузка проблем
async function loadIssues() {
    try {
        const response = await apiCall('/api/issues');
        
        if (!response.issues || response.issues.length === 0) {
            $('#issues').html('<p class="text-success text-center"><i class="fas fa-check me-2"></i>Проблем не найдено</p>');
            return;
        }
        
        const html = response.issues.map(issue => `
            <div class="alert alert-${issue.severity} py-2 mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-${issue.icon || 'exclamation-triangle'} me-2"></i>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${issue.title}</div>
                        <small>${issue.description}</small>
                    </div>
                </div>
            </div>
        `).join('');
        
        $('#issues').html(html);
    } catch (error) {
        console.error('Error loading issues:', error);
        $('#issues').html('<p class="text-muted text-center">Ошибка проверки</p>');
    }
}

// Загрузка последних изменений
async function loadRecentChanges() {
    try {
        const filter = $('#changesFilter').val();
        const response = await apiCall(`/api/recent-changes?filter=${filter}`);
        
        if (!response.changes || response.changes.length === 0) {
            $('#recentChanges').html('<p class="text-muted text-center">Нет изменений</p>');
            return;
        }
        
        const html = response.changes.map(change => {
            const iconMap = {
                'added': 'plus-circle text-success',
                'modified': 'edit text-warning',
                'deleted': 'trash text-danger'
            };
            
            return `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="me-3">
                        <i class="fas fa-${iconMap[change.type] || 'info-circle'}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${change.file_name}</div>
                        <small class="text-muted">${change.path}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${change.type === 'added' ? 'success' : change.type === 'modified' ? 'warning' : 'danger'}">
                            ${change.type === 'added' ? 'Добавлен' : change.type === 'modified' ? 'Изменен' : 'Удален'}
                        </span>
                        <div class="small text-muted mt-1">${formatDate(change.timestamp)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        $('#recentChanges').html(html);
    } catch (error) {
        console.error('Error loading recent changes:', error);
        $('#recentChanges').html('<p class="text-muted text-center">Ошибка загрузки изменений</p>');
    }
}

// Обновление дашборда
function refreshDashboard() {
    showAlert('Обновление дашборда...', 'info');
    loadDashboardData();
}

// Экспорт отчета
function exportReport() {
    // TODO: Реализовать экспорт отчета
    showAlert('Функция экспорта отчета будет реализована', 'info');
}
</script>
{% endblock %}