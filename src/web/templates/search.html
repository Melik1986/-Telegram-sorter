{% extends "base.html" %} 
{% block title %}Поиск - DevDataSorter{% endblock %}
{% block content %}

<!-- Search Header -->
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2>
          <i class="fas fa-search me-2 text-primary"></i>
          Расширенный поиск
        </h2>
        <p class="text-muted mb-0">
          Найдите нужные файлы с помощью семантического поиска и фильтров
        </p>
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" onclick="saveSearch()">
          <i class="fas fa-bookmark me-2"></i>
          Сохранить поиск
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
          <i class="fas fa-times me-2"></i>
          Очистить
        </button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Search Sidebar -->
  <div class="col-md-3">
    <div class="sidebar">
      <!-- Search Form -->
      <form id="advancedSearchForm" onsubmit="performSearch(); return false;">
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-search me-2"></i>
            Поисковый запрос
          </h6>

          <div class="mb-3 position-relative">
            <input
              type="text"
              class="form-control"
              id="searchQuery"
              name="searchQuery"
              placeholder="Введите запрос..."
              autocomplete="off"
              aria-label="Поисковый запрос"
            />
            <div
              id="searchSuggestions"
              class="list-group shadow-sm w-100 position-absolute"
              style="top: 100%; z-index: 1000; display: none;"
              role="listbox"
              aria-label="Подсказки поиска"
            ></div>
          </div>

          <div class="mb-3">
            <label class="form-label">Тип поиска</label>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="semanticSearch"
                name="semanticSearch"
                checked
              />
              <label class="form-check-label" for="semanticSearch">
                <i class="fas fa-brain me-1"></i>
                Семантический
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="keywordSearch"
                name="keywordSearch"
                checked
              />
              <label class="form-check-label" for="keywordSearch">
                <i class="fas fa-key me-1"></i>
                По ключевым словам
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="metadataSearch"
                name="metadataSearch"
                checked
              />
              <label class="form-check-label" for="metadataSearch">
                <i class="fas fa-tags me-1"></i>
                По метаданным
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="naturalCommands"
                name="naturalCommands"
              />
              <label class="form-check-label" for="naturalCommands">
                <i class="fas fa-comments me-1"></i>
                Естественные команды
              </label>
            </div>
          </div>
        </div>

        <!-- Category Filter -->
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-folder me-2"></i>
            Категории
          </h6>

          <div class="mb-3">
            <select class="form-select" id="categoryFilter" name="category">
              <option value="">Все категории</option>
              <option value="code">Код</option>
              <option value="documentation">Документация</option>
              <option value="tutorial">Туториалы</option>
              <option value="reference">Справочники</option>
              <option value="project">Проекты</option>
              <option value="other">Другое</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label" for="subcategoryFilter">Подкатегория</label>
            <select class="form-select" id="subcategoryFilter" name="subcategory">
              <option value="">Все подкатегории</option>
            </select>
          </div>
        </div>

        <!-- File Type Filter -->
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-file me-2"></i>
            Тип файла
          </h6>

          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              id="fileExtension"
              name="fileExtension"
              placeholder="Расширение (например: .py, .js)"
              pattern="[.][a-zA-Z0-9]+"
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Размер файла</label>
            <div class="row">
              <div class="col-6">
                <input
                  type="number"
                  class="form-control form-control-sm"
                  id="minSize"
                  name="minSize"
                  placeholder="Мин (KB)"
                  min="0"
                />
              </div>
              <div class="col-6">
                <input
                  type="number"
                  class="form-control form-control-sm"
                  id="maxSize"
                  name="maxSize"
                  placeholder="Макс (KB)"
                  min="0"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Date Filter -->
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-calendar me-2"></i>
            Дата изменения
          </h6>

          <div class="mb-3">
            <label class="form-label" for="dateFrom">От</label>
            <input 
              type="date" 
              class="form-control" 
              id="dateFrom" 
              name="dateFrom"
              max="{{ today_date }}"
            />
          </div>

          <div class="mb-3">
            <label class="form-label" for="dateTo">До</label>
            <input 
              type="date" 
              class="form-control" 
              id="dateTo"
              name="dateTo" 
              max="{{ today_date }}"
            />
          </div>

          <div class="mb-3">
            <label class="form-label" for="datePreset">Быстрый выбор</label>
            <select class="form-select" id="datePreset" name="datePreset">
              <option value="">Выберите период</option>
              <option value="today">Сегодня</option>
              <option value="week">Последняя неделя</option>
              <option value="month">Последний месяц</option>
              <option value="quarter">Последние 3 месяца</option>
              <option value="year">Последний год</option>
            </select>
          </div>
        </div>

        <!-- Tags Filter -->
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-tags me-2"></i>
            Теги
          </h6>

          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              id="tagsInput"
              name="tags"
              placeholder="Введите теги через запятую"
            />
            <small class="text-muted">Например: react, javascript, api</small>
          </div>

          <div id="popularTags" class="mb-3">
            <label class="form-label">Популярные теги</label>
            <div id="tagsList" class="d-flex flex-wrap gap-1">
              <div class="text-center py-2">
                <small class="text-muted">Загрузка...</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Path Filter -->
        <div class="filter-section">
          <h6 class="filter-title">
            <i class="fas fa-folder-tree me-2"></i>
            Путь
          </h6>

          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              id="pathFilter"
              name="path"
              placeholder="Путь к папке"
            />
            <small class="text-muted">Например: /src/components</small>
          </div>

          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="includeSubfolders"
              name="includeSubfolders"
              checked
            />
            <label class="form-check-label" for="includeSubfolders">
              Включить подпапки
            </label>
          </div>
        </div>

        <!-- Search Button -->
        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>
            Найти
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Search Results -->
  <div class="col-md-9">
    <!-- Search Stats -->
    <div id="searchStats" class="mb-3 d-none">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="text-muted">Найдено: </span>
          <span class="fw-bold" id="resultsCount">0</span>
          <span class="text-muted"> результатов за </span>
          <span class="fw-bold" id="searchTime">0</span>
          <span class="text-muted"> мс</span>
        </div>
        <div class="d-flex gap-2">
          <select
            class="form-select form-select-sm"
            id="sortBy"
            style="width: auto"
          >
            <option value="relevance">По релевантности</option>
            <option value="name">По имени</option>
            <option value="date">По дате</option>
            <option value="size">По размеру</option>
          </select>
          <select
            class="form-select form-select-sm"
            id="sortOrder"
            style="width: auto"
          >
            <option value="desc">По убыванию</option>
            <option value="asc">По возрастанию</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="searchLoading" class="loading text-center d-none">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Загрузка...</span>
      </div>
      <p class="mt-2">Поиск...</p>
    </div>

    <!-- No Results -->
    <div id="noResults" class="text-center py-5 d-none">
      <i class="fas fa-search fa-4x text-muted mb-3"></i>
      <h4 class="text-muted">Результаты не найдены</h4>
      <p class="text-muted">
        Попробуйте изменить параметры поиска или использовать другие ключевые
        слова
      </p>
      <button type="button" class="btn btn-outline-primary" onclick="clearSearch()">
        <i class="fas fa-refresh me-2"></i>
        Очистить фильтры
      </button>
    </div>

    <!-- Search Results -->
    <div id="searchResults">
      <!-- Welcome Message -->
      <div id="welcomeMessage" class="text-center py-5">
        <i class="fas fa-search fa-4x text-primary mb-3"></i>
        <h4>Добро пожаловать в расширенный поиск</h4>
        <p class="text-muted">
          Используйте фильтры слева для настройки поиска или введите запрос выше
        </p>

        <div class="row mt-4">
          <div class="col-md-4">
            <div class="card border-0 bg-light h-100">
              <div class="card-body text-center">
                <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                <h6>Семантический поиск</h6>
                <small class="text-muted">Поиск по смыслу и контексту</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 bg-light h-100">
              <div class="card-body text-center">
                <i class="fas fa-filter fa-2x text-success mb-2"></i>
                <h6>Умные фильтры</h6>
                <small class="text-muted">Фильтрация по множеству параметров</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-0 bg-light h-100">
              <div class="card-body text-center">
                <i class="fas fa-comments fa-2x text-info mb-2"></i>
                <h6>Естественные команды</h6>
                <small class="text-muted">Поиск обычными фразами</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <nav id="pagination" class="d-flex justify-content-center mt-4 d-none">
      <ul class="pagination" id="paginationList"></ul>
    </nav>
  </div>
</div>

<!-- Saved Searches Modal -->
<div class="modal fade" id="savedSearchesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-bookmark me-2"></i>
          Сохраненные поиски
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Закрыть"
        ></button>
      </div>
      <div class="modal-body">
        <div id="savedSearchesList">
          <div class="text-center py-4">
            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
            <p class="text-muted">У вас пока нет сохраненных поисков</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Global variables
  let currentPage = 1;
  let totalPages = 1;
  let currentResults = [];
  let searchTimeout = null;
  let suggestionsCache = new Map();

  // Initialize search functionality
  $(document).ready(function() {
    initializeSearch();
    loadPopularTags();
    loadSavedSearches();
    setupEventHandlers();
    setupSearchAutocomplete();

    // Handle keyboard shortcuts
    $(document).on('keydown', function(e) {
      // Ctrl+S for saving search
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveSearch();
      }

      // Ctrl+Enter for performing search
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        performSearch();
      }

      // Escape for clearing suggestions
      if (e.key === 'Escape') {
        $('#searchSuggestions').hide();
      }
    });
  });

  // Initialize search functionality
  function initializeSearch() {
    const searchInput = $('#searchQuery');
    const suggestionsDiv = $('#searchSuggestions');

    // Handle input changes for autocomplete
    searchInput.on('input', debounce(function() {
      const query = $(this).val().trim();

      if (query.length < 2) {
        suggestionsDiv.hide().empty();
        return;
      }

      getSearchSuggestions(query);
    }, 300));

    // Hide suggestions when clicking outside
    $(document).on('click', function(e) {
      if (!$(e.target).closest('.sidebar').length) {
        suggestionsDiv.hide();
      }
    });
  }

  // Setup event handlers
  function setupEventHandlers() {
    // Form submission
    $('#advancedSearchForm').on('submit', function(e) {
      e.preventDefault();
      performSearch();
    });

    // Category change
    $('#categoryFilter').on('change', function() {
      loadSubcategories($(this).val());
    });

    // Date preset change
    $('#datePreset').on('change', function() {
      setDatePreset($(this).val());
    });

    // Sort change
    $('#sortBy, #sortOrder').on('change', function() {
      if (currentResults.length > 0) {
        sortAndDisplayResults();
      }
    });

    // Tags input
    $('#tagsInput').on('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const tag = $(this).val().trim();
        if (tag) {
          addTag(tag);
          $(this).val('');
        }
      }
    });
  }

  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Get search suggestions
  async function getSearchSuggestions(query) {
    if (suggestionsCache.has(query)) {
      showSearchSuggestions(suggestionsCache.get(query));
      return;
    }

    try {
      const response = await apiCall('/api/search-suggestions', {
        method: 'POST',
        body: JSON.stringify({ query })
      });

      if (response.suggestions) {
        suggestionsCache.set(query, response.suggestions);
        showSearchSuggestions(response.suggestions);
      }
    } catch (error) {
      console.error('Error getting search suggestions:', error);
    }
  }

  // Show search suggestions
  function showSearchSuggestions(suggestions) {
    const suggestionsDiv = $('#searchSuggestions');
    suggestionsDiv.empty();

    if (!suggestions || suggestions.length === 0) {
      suggestionsDiv.hide();
      return;
    }

    suggestions.forEach(suggestion => {
      const item = $(`
        <button type="button" 
          class="list-group-item list-group-item-action d-flex align-items-center"
          role="option"
        >
          <i class="fas fa-${suggestion.icon || 'search'} me-2 text-muted"></i>
          <span>${escapeHtml(suggestion.text)}</span>
          ${suggestion.type ? 
            `<span class="badge bg-secondary ms-auto">${escapeHtml(suggestion.type)}</span>` 
            : ''}
        </button>
      `);

      item.on('click', function() {
        $('#searchQuery').val(suggestion.text);
        suggestionsDiv.hide();
        performSearch();
      });

      suggestionsDiv.append(item);
    });

    suggestionsDiv.show();
  }

  // Escape HTML
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Perform search
  async function performSearch(page = 1) {
    const searchData = collectSearchData();

    if (!searchData.query && !hasFilters(searchData)) {
      showAlert('Введите поисковый запрос или установите фильтры', 'warning');
      return;
    }

    currentPage = page;

    showLoading();
    hideElements(['#welcomeMessage', '#noResults', '#searchStats', '#pagination']);

    try {
      const startTime = Date.now();

      const response = await apiCall('/api/advanced-search', {
        method: 'POST',
        body: JSON.stringify({
          ...searchData,
          page,
          per_page: 20
        })
      });

      const searchTime = Date.now() - startTime;

      currentResults = response.results || [];
      totalPages = response.total_pages || 1;

      displaySearchResults(response, searchTime);
    } catch (error) {
      console.error('Search error:', error);
      showAlert('Ошибка при выполнении поиска', 'danger');
      showElement('#noResults');
    } finally {
      hideLoading();
    }
  }

  // Show loading state
  function showLoading() {
    $('#searchLoading').removeClass('d-none');
  }

  // Hide loading state
  function hideLoading() {
    $('#searchLoading').addClass('d-none');
  }

  // Show element
  function showElement(selector) {
    $(selector).removeClass('d-none');
  }

  // Hide elements
  function hideElements(selectors) {
    selectors.forEach(selector => $(selector).addClass('d-none'));
  }

  // Show alert
  function showAlert(message, type) {
    const alert = $(`
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
      </div>
    `);
    
    $('#alerts').append(alert);
    setTimeout(() => alert.alert('close'), 5000);
  }

  // API call helper
  async function apiCall(url, options = {}) {
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });

    if (!response.ok) {
      throw new Error(`API call failed: ${response.status}`);
    }

    return response.json();
  }
</script>
{% endblock %}
