{% extends "base.html" %}

{% block title %}Поиск - DevDataSorter{% endblock %}

{% block content %}
<!-- Search Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-search me-2 text-primary"></i>
                    Расширенный поиск
                </h2>
                <p class="text-muted mb-0">Найдите нужные файлы с помощью семантического поиска и фильтров</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="saveSearch()">
                    <i class="fas fa-bookmark me-2"></i>
                    Сохранить поиск
                </button>
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="fas fa-times me-2"></i>
                    Очистить
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Search Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <!-- Search Form -->
            <form id="advancedSearchForm">
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-search me-2"></i>
                        Поисковый запрос
                    </h6>
                    
                    <div class="mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="searchQuery" 
                               placeholder="Введите запрос..."
                               autocomplete="off">
                        <div id="searchSuggestions" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Тип поиска</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="semanticSearch" checked>
                            <label class="form-check-label" for="semanticSearch">
                                <i class="fas fa-brain me-1"></i>
                                Семантический
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="keywordSearch" checked>
                            <label class="form-check-label" for="keywordSearch">
                                <i class="fas fa-key me-1"></i>
                                По ключевым словам
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="metadataSearch" checked>
                            <label class="form-check-label" for="metadataSearch">
                                <i class="fas fa-tags me-1"></i>
                                По метаданным
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="naturalCommands">
                            <label class="form-check-label" for="naturalCommands">
                                <i class="fas fa-comments me-1"></i>
                                Естественные команды
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Category Filter -->
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-folder me-2"></i>
                        Категории
                    </h6>
                    
                    <div class="mb-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">Все категории</option>
                            <option value="code">Код</option>
                            <option value="documentation">Документация</option>
                            <option value="tutorial">Туториалы</option>
                            <option value="reference">Справочники</option>
                            <option value="project">Проекты</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Подкатегория</label>
                        <select class="form-select" id="subcategoryFilter">
                            <option value="">Все подкатегории</option>
                        </select>
                    </div>
                </div>
                
                <!-- File Type Filter -->
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-file me-2"></i>
                        Тип файла
                    </h6>
                    
                    <div class="mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="fileExtension" 
                               placeholder="Расширение (например: .py, .js)">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Размер файла</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       id="minSize" 
                                       placeholder="Мин (KB)">
                            </div>
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       id="maxSize" 
                                       placeholder="Макс (KB)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Date Filter -->
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-calendar me-2"></i>
                        Дата изменения
                    </h6>
                    
                    <div class="mb-3">
                        <label class="form-label">От</label>
                        <input type="date" class="form-control" id="dateFrom">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">До</label>
                        <input type="date" class="form-control" id="dateTo">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Быстрый выбор</label>
                        <select class="form-select" id="datePreset">
                            <option value="">Выберите период</option>
                            <option value="today">Сегодня</option>
                            <option value="week">Последняя неделя</option>
                            <option value="month">Последний месяц</option>
                            <option value="quarter">Последние 3 месяца</option>
                            <option value="year">Последний год</option>
                        </select>
                    </div>
                </div>
                
                <!-- Tags Filter -->
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-tags me-2"></i>
                        Теги
                    </h6>
                    
                    <div class="mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="tagsInput" 
                               placeholder="Введите теги через запятую">
                        <small class="text-muted">Например: react, javascript, api</small>
                    </div>
                    
                    <div id="popularTags" class="mb-3">
                        <label class="form-label">Популярные теги</label>
                        <div id="tagsList">
                            <div class="text-center py-2">
                                <small class="text-muted">Загрузка...</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Path Filter -->
                <div class="filter-section">
                    <h6 class="filter-title">
                        <i class="fas fa-folder-tree me-2"></i>
                        Путь
                    </h6>
                    
                    <div class="mb-3">
                        <input type="text" 
                               class="form-control" 
                               id="pathFilter" 
                               placeholder="Путь к папке">
                        <small class="text-muted">Например: /src/components</small>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSubfolders" checked>
                        <label class="form-check-label" for="includeSubfolders">
                            Включить подпапки
                        </label>
                    </div>
                </div>
                
                <!-- Search Button -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>
                        Найти
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Search Results -->
    <div class="col-md-9">
        <!-- Search Stats -->
        <div id="searchStats" class="mb-3" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted">Найдено: </span>
                    <span class="fw-bold" id="resultsCount">0</span>
                    <span class="text-muted"> результатов за </span>
                    <span class="fw-bold" id="searchTime">0</span>
                    <span class="text-muted"> мс</span>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="sortBy" style="width: auto;">
                        <option value="relevance">По релевантности</option>
                        <option value="name">По имени</option>
                        <option value="date">По дате</option>
                        <option value="size">По размеру</option>
                    </select>
                    <select class="form-select form-select-sm" id="sortOrder" style="width: auto;">
                        <option value="desc">По убыванию</option>
                        <option value="asc">По возрастанию</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Loading -->
        <div id="searchLoading" class="loading text-center">
            <div class="spinner"></div>
            <p class="mt-2">Поиск...</p>
        </div>
        
        <!-- No Results -->
        <div id="noResults" class="text-center py-5" style="display: none;">
            <i class="fas fa-search fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">Результаты не найдены</h4>
            <p class="text-muted">Попробуйте изменить параметры поиска или использовать другие ключевые слова</p>
            <button class="btn btn-outline-primary" onclick="clearSearch()">
                <i class="fas fa-refresh me-2"></i>
                Очистить фильтры
            </button>
        </div>
        
        <!-- Search Results -->
        <div id="searchResults">
            <!-- Welcome Message -->
            <div id="welcomeMessage" class="text-center py-5">
                <i class="fas fa-search fa-4x text-primary mb-3"></i>
                <h4>Добро пожаловать в расширенный поиск</h4>
                <p class="text-muted">Используйте фильтры слева для настройки поиска или введите запрос выше</p>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                                <h6>Семантический поиск</h6>
                                <small class="text-muted">Поиск по смыслу и контексту</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-filter fa-2x text-success mb-2"></i>
                                <h6>Умные фильтры</h6>
                                <small class="text-muted">Фильтрация по множеству параметров</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-comments fa-2x text-info mb-2"></i>
                                <h6>Естественные команды</h6>
                                <small class="text-muted">Поиск обычными фразами</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="d-flex justify-content-center mt-4" style="display: none;">
            <nav>
                <ul class="pagination" id="paginationList">
                    <!-- Pagination items will be generated here -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Saved Searches Modal -->
<div class="modal fade" id="savedSearchesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bookmark me-2"></i>
                    Сохраненные поиски
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="savedSearchesList">
                    <div class="text-center py-4">
                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                        <p class="text-muted">У вас пока нет сохраненных поисков</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Глобальные переменные
let currentPage = 1;
let totalPages = 1;
let currentResults = [];
let searchTimeout;
let suggestionsCache = new Map();

// Инициализация
$(document).ready(function() {
    initializeSearch();
    loadPopularTags();
    loadSavedSearches();
    setupEventHandlers();
    setupSearchAutocomplete();
    
    // Горячие клавиши
    $(document).on('keydown', function(e) {
        // Ctrl+S для сохранения поиска
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveSearch();
        }
        
        // Ctrl+Enter для выполнения поиска
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
        
        // Escape для очистки
        if (e.key === 'Escape') {
            $('#searchSuggestions').hide();
        }
    });
});

// Инициализация поиска
function initializeSearch() {
    const searchInput = $('#searchQuery');
    const suggestionsDiv = $('#searchSuggestions');
    
    // Автодополнение
    searchInput.on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            suggestionsDiv.hide().empty();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            getSearchSuggestions(query);
        }, 300);
    });
    
    // Скрытие подсказок при клике вне
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.sidebar').length) {
            suggestionsDiv.hide();
        }
    });
}

// Настройка обработчиков событий
function setupEventHandlers() {
    // Форма поиска
    $('#advancedSearchForm').on('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // Изменение категории
    $('#categoryFilter').on('change', function() {
        loadSubcategories($(this).val());
    });
    
    // Быстрый выбор даты
    $('#datePreset').on('change', function() {
        setDatePreset($(this).val());
    });
    
    // Сортировка
    $('#sortBy, #sortOrder').on('change', function() {
        if (currentResults.length > 0) {
            sortAndDisplayResults();
        }
    });
    
    // Теги
    $('#tagsInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter
            e.preventDefault();
            addTag($(this).val().trim());
            $(this).val('');
        }
    });
}

// Получение подсказок для поиска
async function getSearchSuggestions(query) {
    if (suggestionsCache.has(query)) {
        showSearchSuggestions(suggestionsCache.get(query));
        return;
    }
    
    try {
        const response = await apiCall('/api/search-suggestions', {
            method: 'POST',
            body: JSON.stringify({ query: query })
        });
        
        suggestionsCache.set(query, response.suggestions);
        showSearchSuggestions(response.suggestions);
    } catch (error) {
        console.error('Error getting search suggestions:', error);
    }
}

// Отображение подсказок поиска
function showSearchSuggestions(suggestions) {
    const suggestionsDiv = $('#searchSuggestions');
    suggestionsDiv.empty();
    
    if (suggestions.length === 0) {
        suggestionsDiv.hide();
        return;
    }
    
    suggestions.forEach(suggestion => {
        const item = $(`
            <button type="button" class="list-group-item list-group-item-action d-flex align-items-center">
                <i class="fas fa-${suggestion.icon || 'search'} me-2 text-muted"></i>
                <span>${suggestion.text}</span>
                ${suggestion.type ? `<span class="badge bg-secondary ms-auto">${suggestion.type}</span>` : ''}
            </button>
        `);
        
        item.on('click', function() {
            $('#searchQuery').val(suggestion.text);
            suggestionsDiv.hide();
            performSearch();
        });
        
        suggestionsDiv.append(item);
    });
    
    suggestionsDiv.show();
}

// Выполнение поиска
async function performSearch(page = 1) {
    const searchData = collectSearchData();
    
    if (!searchData.query && !hasFilters(searchData)) {
        showAlert('Введите поисковый запрос или установите фильтры', 'warning');
        return;
    }
    
    currentPage = page;
    
    showLoading('#searchLoading');
    hideElements(['#welcomeMessage', '#noResults', '#searchStats', '#pagination']);
    
    try {
        const startTime = Date.now();
        
        const response = await apiCall('/api/advanced-search', {
            method: 'POST',
            body: JSON.stringify({
                ...searchData,
                page: page,
                per_page: 20
            })
        });
        
        const searchTime = Date.now() - startTime;
        
        currentResults = response.results || [];
        totalPages = response.total_pages || 1;
        
        displaySearchResults(response, searchTime);
        
    } catch (error) {
        console.error('Search error:', error);
        showAlert('Ошибка при выполнении поиска', 'danger');
        showElement('#noResults');
    } finally {
        hideLoading('#searchLoading');
    }
}

// Сбор данных поиска
function collectSearchData() {
    return {
        query: $('#searchQuery').val().trim(),
        search_types: {
            semantic: $('#semanticSearch').is(':checked'),
            keyword: $('#keywordSearch').is(':checked'),
            metadata: $('#metadataSearch').is(':checked'),
            natural_commands: $('#naturalCommands').is(':checked')
        },
        filters: {
            category: $('#categoryFilter').val(),
            subcategory: $('#subcategoryFilter').val(),
            file_extension: $('#fileExtension').val(),
            min_size: $('#minSize').val() ? parseInt($('#minSize').val()) * 1024 : null,
            max_size: $('#maxSize').val() ? parseInt($('#maxSize').val()) * 1024 : null,
            date_from: $('#dateFrom').val(),
            date_to: $('#dateTo').val(),
            tags: $('#tagsInput').val().split(',').map(t => t.trim()).filter(t => t),
            path: $('#pathFilter').val(),
            include_subfolders: $('#includeSubfolders').is(':checked')
        },
        sort: {
            by: $('#sortBy').val(),
            order: $('#sortOrder').val()
        }
    };
}

// Проверка наличия фильтров
function hasFilters(searchData) {
    const filters = searchData.filters;
    return Object.values(filters).some(value => {
        if (Array.isArray(value)) {
            return value.length > 0;
        }
        return value !== null && value !== '' && value !== undefined;
    });
}

// Отображение результатов поиска
function displaySearchResults(response, searchTime) {
    const resultsContainer = $('#searchResults');
    
    if (!response.results || response.results.length === 0) {
        showElement('#noResults');
        return;
    }
    
    // Обновление статистики
    $('#resultsCount').text(response.total_results || 0);
    $('#searchTime').text(searchTime);
    showElement('#searchStats');
    
    // Отображение результатов
    const resultsHtml = response.results.map(result => createSearchResultItem(result)).join('');
    resultsContainer.html(resultsHtml);
    
    // Пагинация
    if (totalPages > 1) {
        createPagination();
        showElement('#pagination');
    }
}

// Создание элемента результата поиска
function createSearchResultItem(result) {
    const categoryIcons = {
        'code': 'code',
        'documentation': 'book',
        'tutorial': 'graduation-cap',
        'reference': 'bookmark',
        'project': 'folder',
        'other': 'file'
    };
    
    const tagsHtml = result.tags ? result.tags.map(tag => 
        `<span class="badge bg-secondary me-1">${tag}</span>`
    ).join('') : '';
    
    return `
        <div class="result-item mb-3">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    <i class="fas fa-${categoryIcons[result.category] || 'file'} fa-2x text-primary"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <a href="#" class="text-decoration-none" onclick="openFile('${result.path}')">
                                ${result.title || result.name}
                            </a>
                        </h6>
                        <span class="badge bg-success ms-2">${Math.round(result.score * 100)}%</span>
                    </div>
                    
                    <p class="text-muted mb-2 small">
                        <i class="fas fa-folder me-1"></i>
                        ${result.path}
                    </p>
                    
                    ${result.description ? `<p class="mb-2">${result.description}</p>` : ''}
                    
                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <span class="badge bg-primary">${result.category}</span>
                            ${result.subcategory ? `<span class="badge bg-info">${result.subcategory}</span>` : ''}
                            ${tagsHtml}
                        </div>
                        
                        <div class="d-flex align-items-center gap-3 text-muted small">
                            ${result.size ? `<span><i class="fas fa-weight me-1"></i>${formatFileSize(result.size)}</span>` : ''}
                            <span><i class="fas fa-clock me-1"></i>${formatDate(result.modified_date)}</span>
                        </div>
                    </div>
                    
                    ${result.preview ? `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="togglePreview(this, '${result.id}')">
                                <i class="fas fa-eye me-1"></i>
                                Предпросмотр
                            </button>
                            <div class="preview-content mt-2" style="display: none;">
                                <pre class="bg-light p-2 rounded"><code>${result.preview}</code></pre>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// Создание пагинации
function createPagination() {
    const paginationList = $('#paginationList');
    paginationList.empty();
    
    // Предыдущая страница
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationList.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);
    
    // Страницы
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationList.append('<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1)">1</a></li>');
        if (startPage > 2) {
            paginationList.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationList.append(`
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
            </li>
        `);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationList.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        }
        paginationList.append(`<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages})">${totalPages}</a></li>`);
    }
    
    // Следующая страница
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationList.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);
}

// Переход на страницу
function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        performSearch(page);
    }
}

// Загрузка популярных тегов
async function loadPopularTags() {
    try {
        const response = await apiCall('/api/popular-tags');
        
        const tagsHtml = response.tags.map(tag => 
            `<button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="addTag('${tag.name}')">
                ${tag.name} (${tag.count})
            </button>`
        ).join('');
        
        $('#tagsList').html(tagsHtml);
    } catch (error) {
        console.error('Error loading popular tags:', error);
        $('#tagsList').html('<small class="text-muted">Ошибка загрузки тегов</small>');
    }
}

// Загрузка подкатегорий
async function loadSubcategories(category) {
    const subcategorySelect = $('#subcategoryFilter');
    subcategorySelect.html('<option value="">Все подкатегории</option>');
    
    if (!category) return;
    
    try {
        const response = await apiCall('/api/categories');
        const categories = response.categories;
        
        if (categories[category]) {
            categories[category].forEach(subcategory => {
                subcategorySelect.append(`<option value="${subcategory}">${subcategory}</option>`);
            });
        }
    } catch (error) {
        console.error('Error loading subcategories:', error);
    }
}

// Установка предустановленной даты
function setDatePreset(preset) {
    const now = new Date();
    let fromDate, toDate;
    
    switch (preset) {
        case 'today':
            fromDate = toDate = now.toISOString().split('T')[0];
            break;
        case 'week':
            fromDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            toDate = now.toISOString().split('T')[0];
            break;
        case 'month':
            fromDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()).toISOString().split('T')[0];
            toDate = now.toISOString().split('T')[0];
            break;
        case 'quarter':
            fromDate = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate()).toISOString().split('T')[0];
            toDate = now.toISOString().split('T')[0];
            break;
        case 'year':
            fromDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate()).toISOString().split('T')[0];
            toDate = now.toISOString().split('T')[0];
            break;
        default:
            return;
    }
    
    $('#dateFrom').val(fromDate);
    $('#dateTo').val(toDate);
}

// Добавление тега
function addTag(tagName) {
    if (!tagName) return;
    
    const tagsInput = $('#tagsInput');
    const currentTags = tagsInput.val().split(',').map(t => t.trim()).filter(t => t);
    
    if (!currentTags.includes(tagName)) {
        currentTags.push(tagName);
        tagsInput.val(currentTags.join(', '));
    }
}

// Сортировка и отображение результатов
function sortAndDisplayResults() {
    const sortBy = $('#sortBy').val();
    const sortOrder = $('#sortOrder').val();
    
    currentResults.sort((a, b) => {
        let aVal, bVal;
        
        switch (sortBy) {
            case 'name':
                aVal = a.name || a.title;
                bVal = b.name || b.title;
                break;
            case 'date':
                aVal = new Date(a.modified_date);
                bVal = new Date(b.modified_date);
                break;
            case 'size':
                aVal = a.size || 0;
                bVal = b.size || 0;
                break;
            default: // relevance
                aVal = a.score;
                bVal = b.score;
        }
        
        if (sortOrder === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    const resultsHtml = currentResults.map(result => createSearchResultItem(result)).join('');
    $('#searchResults').html(resultsHtml);
}

// Переключение предпросмотра
function togglePreview(button, resultId) {
    const previewDiv = $(button).siblings('.preview-content');
    const icon = $(button).find('i');
    
    if (previewDiv.is(':visible')) {
        previewDiv.hide();
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
        $(button).find('span').text('Предпросмотр');
    } else {
        previewDiv.show();
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
        $(button).find('span').text('Скрыть');
    }
}

// Очистка поиска
function clearSearch() {
    $('#advancedSearchForm')[0].reset();
    $('#searchSuggestions').hide();
    $('#searchResults').html($('#welcomeMessage'));
    hideElements(['#searchStats', '#pagination', '#noResults']);
    showElement('#welcomeMessage');
    currentResults = [];
    currentPage = 1;
}

// Сохранение поиска
async function saveSearch() {
    const searchData = collectSearchData();
    
    if (!searchData.query && !hasFilters(searchData)) {
        showAlert('Нечего сохранять - введите запрос или установите фильтры', 'warning');
        return;
    }
    
    const searchName = prompt('Введите название для сохраненного поиска:');
    if (!searchName) return;
    
    try {
        const saveData = {
            name: searchName,
            query: searchData.query,
            filters: searchData.filters,
            sort: searchData.sort,
            created_at: new Date().toISOString()
        };
        
        await apiCall('/api/saved-searches', {
            method: 'POST',
            body: JSON.stringify(saveData)
        });
        
        showAlert(`Поиск "${searchName}" сохранен`, 'success');
        loadSavedSearches();
    } catch (error) {
        console.error('Error saving search:', error);
        showAlert('Ошибка при сохранении поиска', 'danger');
    }
}

// Открытие файла
function openFile(path) {
    // Открытие файла в новой вкладке
    window.open(`/file/${encodeURIComponent(path)}`, '_blank');
}

// Загрузка сохраненных поисков
async function loadSavedSearches() {
    try {
        const response = await apiCall('/api/saved-searches');
        const dropdown = $('#savedSearchesDropdown');
        
        if (response.searches && response.searches.length > 0) {
            const searchesHtml = response.searches.map(search => 
                `<li><a class="dropdown-item" href="#" onclick="loadSavedSearch('${search.id}')">
                    <i class="fas fa-search me-2"></i>${search.name}
                    <small class="text-muted d-block">${new Date(search.created_at).toLocaleDateString()}</small>
                </a></li>`
            ).join('');
            
            dropdown.html(searchesHtml + 
                '<li><hr class="dropdown-divider"></li>' +
                '<li><a class="dropdown-item text-danger" href="#" onclick="clearSavedSearches()">' +
                '<i class="fas fa-trash me-2"></i>Очистить все</a></li>'
            );
        } else {
            dropdown.html('<li><span class="dropdown-item-text text-muted">Нет сохраненных поисков</span></li>');
        }
    } catch (error) {
        console.error('Error loading saved searches:', error);
    }
}

// Загрузка сохраненного поиска
async function loadSavedSearch(searchId) {
    try {
        const response = await apiCall(`/api/saved-searches/${searchId}`);
        const search = response.search;
        
        // Заполнение формы
        $('#searchQuery').val(search.query || '');
        
        // Заполнение фильтров
        if (search.filters) {
            $('#categoryFilter').val(search.filters.category || '');
            $('#subcategoryFilter').val(search.filters.subcategory || '');
            $('#fileExtension').val(search.filters.file_extension || '');
            $('#minSize').val(search.filters.min_size || '');
            $('#maxSize').val(search.filters.max_size || '');
            $('#dateFrom').val(search.filters.date_from || '');
            $('#dateTo').val(search.filters.date_to || '');
            $('#tagsInput').val(search.filters.tags ? search.filters.tags.join(', ') : '');
            $('#pathFilter').val(search.filters.path || '');
            $('#includeSubfolders').prop('checked', search.filters.include_subfolders !== false);
        }
        
        // Заполнение сортировки
        if (search.sort) {
            $('#sortBy').val(search.sort.by || 'relevance');
            $('#sortOrder').val(search.sort.order || 'desc');
        }
        
        // Выполнение поиска
        performSearch();
        
        showAlert(`Загружен поиск: ${search.name}`, 'success');
    } catch (error) {
        console.error('Error loading saved search:', error);
        showAlert('Ошибка при загрузке сохраненного поиска', 'danger');
    }
}

// Очистка сохраненных поисков
async function clearSavedSearches() {
    if (!confirm('Удалить все сохраненные поиски?')) return;
    
    try {
        await apiCall('/api/saved-searches', { method: 'DELETE' });
        loadSavedSearches();
        showAlert('Все сохраненные поиски удалены', 'success');
    } catch (error) {
        console.error('Error clearing saved searches:', error);
        showAlert('Ошибка при удалении сохраненных поисков', 'danger');
    }
}

// Автодополнение поиска
let searchTimeout;
async function setupSearchAutocomplete() {
    $('#searchQuery').on('input', function() {
        const query = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            $('#searchSuggestions').hide();
            return;
        }
        
        searchTimeout = setTimeout(async () => {
            try {
                const response = await apiCall(`/api/search-suggestions?q=${encodeURIComponent(query)}`);
                displaySearchSuggestions(response.suggestions);
            } catch (error) {
                console.error('Error getting search suggestions:', error);
            }
        }, 300);
    });
}

// Отображение подсказок поиска
function displaySearchSuggestions(suggestions) {
    const suggestionsDiv = $('#searchSuggestions');
    
    if (!suggestions || suggestions.length === 0) {
        suggestionsDiv.hide();
        return;
    }
    
    const suggestionsHtml = suggestions.map(suggestion => 
        `<div class="suggestion-item" onclick="applySuggestion('${suggestion.text}', '${suggestion.type}')">
            <i class="fas fa-${suggestion.icon} me-2"></i>
            <span>${suggestion.text}</span>
            <small class="text-muted ms-auto">${suggestion.type}</small>
        </div>`
    ).join('');
    
    suggestionsDiv.html(suggestionsHtml).show();
}

// Применение подсказки
function applySuggestion(text, type) {
    if (type === 'tag') {
        addTag(text);
    } else if (type === 'category') {
        $('#categoryFilter').val(text);
        loadSubcategories(text);
    } else if (type === 'extension') {
        const ext = text.match(/\.(\w+)/)?.[1];
        if (ext) $('#fileExtension').val(ext);
    } else {
        $('#searchQuery').val(text);
    }
    
    $('#searchSuggestions').hide();
    performSearch();
}

// Экспорт результатов поиска
async function exportSearchResults(format = 'json') {
    if (!currentResults || currentResults.length === 0) {
        showAlert('Нет результатов для экспорта', 'warning');
        return;
    }
    
    try {
        const searchData = collectSearchData();
        const exportData = {
            query: searchData.query,
            filters: searchData.filters,
            results: currentResults,
            format: format,
            timestamp: new Date().toISOString()
        };
        
        const response = await fetch('/api/export', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exportData)
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert(`Результаты экспортированы в формате ${format.toUpperCase()}`, 'success');
        } else {
            throw new Error('Export failed');
        }
    } catch (error) {
        console.error('Error exporting results:', error);
        showAlert('Ошибка при экспорте результатов', 'danger');
    }
}

// Вспомогательные функции
function showElement(selector) {
    $(selector).show();
}

function hideElements(selectors) {
    selectors.forEach(selector => $(selector).hide());
}
</script>
{% endblock %}