{% extends "base.html" %}

{% block title %}Отчеты - DevDataSorter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-chart-bar me-2 text-primary"></i>
                    Отчеты и аналитика
                </h2>
                <p class="text-muted mb-0">Генерация отчетов и анализ данных</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshReports()">
                    <i class="fas fa-sync-alt me-2"></i>
                    Обновить
                </button>
                <button class="btn btn-primary" onclick="generateCustomReport()">
                    <i class="fas fa-plus me-2"></i>
                    Создать отчет
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0" id="totalReports">0</h4>
                        <small>Всего отчетов</small>
                    </div>
                    <i class="fas fa-file-alt fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0" id="scheduledReports">0</h4>
                        <small>Запланированных</small>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0" id="recentReports">0</h4>
                        <small>За последний месяц</small>
                    </div>
                    <i class="fas fa-calendar fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0" id="exportedReports">0</h4>
                        <small>Экспортированных</small>
                    </div>
                    <i class="fas fa-download fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Templates -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-templates me-2"></i>
                    Шаблоны отчетов
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="reportTemplates">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reports List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Мои отчеты
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="reportFilter" style="width: auto;">
                            <option value="all">Все отчеты</option>
                            <option value="generated">Сгенерированные</option>
                            <option value="scheduled">Запланированные</option>
                            <option value="failed">С ошибками</option>
                        </select>
                        <input type="text" class="form-control form-control-sm" id="reportSearch" placeholder="Поиск..." style="width: 200px;">
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="reportsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Название</th>
                                <th>Тип</th>
                                <th>Статус</th>
                                <th>Создан</th>
                                <th>Размер</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Reports will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading State -->
                <div id="reportsLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2 text-muted">Загрузка отчетов...</p>
                </div>
                
                <!-- Empty State -->
                <div id="reportsEmpty" class="text-center py-5" style="display: none;">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Нет отчетов</h5>
                    <p class="text-muted">Создайте свой первый отчет, используя шаблоны выше</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="row mt-4" id="reportsPaginationContainer" style="display: none;">
    <div class="col-12">
        <nav aria-label="Reports pagination">
            <ul class="pagination justify-content-center" id="reportsPagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Custom Report Modal -->
<div class="modal fade" id="customReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создание пользовательского отчета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customReportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportName" class="form-label">Название отчета</label>
                                <input type="text" class="form-control" id="reportName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportType" class="form-label">Тип отчета</label>
                                <select class="form-select" id="reportType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="file_analysis">Анализ файлов</option>
                                    <option value="category_stats">Статистика по категориям</option>
                                    <option value="size_analysis">Анализ размеров</option>
                                    <option value="activity_report">Отчет активности</option>
                                    <option value="duplicate_analysis">Анализ дубликатов</option>
                                    <option value="custom_query">Пользовательский запрос</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="reportDescription" rows="3"></textarea>
                    </div>
                    
                    <!-- Filters Section -->
                    <div class="mb-3">
                        <h6>Фильтры</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="dateRange" class="form-label">Период</label>
                                <select class="form-select" id="dateRange">
                                    <option value="all">Все время</option>
                                    <option value="last_week">Последняя неделя</option>
                                    <option value="last_month">Последний месяц</option>
                                    <option value="last_quarter">Последний квартал</option>
                                    <option value="last_year">Последний год</option>
                                    <option value="custom">Пользовательский</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="categoryFilter" class="form-label">Категории</label>
                                <select class="form-select" id="categoryFilter" multiple>
                                    <!-- Categories will be loaded here -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3" id="customDateRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Дата начала</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="col-md-6">
                                <label for="endDate" class="form-label">Дата окончания</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="minSize" class="form-label">Минимальный размер (MB)</label>
                                <input type="number" class="form-control" id="minSize" min="0" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="maxSize" class="form-label">Максимальный размер (MB)</label>
                                <input type="number" class="form-control" id="maxSize" min="0" step="0.1">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="pathFilter" class="form-label">Фильтр по пути</label>
                            <input type="text" class="form-control" id="pathFilter" placeholder="Например: /src/**, *.js">
                        </div>
                    </div>
                    
                    <!-- Output Options -->
                    <div class="mb-3">
                        <h6>Параметры вывода</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="outputFormat" class="form-label">Формат</label>
                                <select class="form-select" id="outputFormat">
                                    <option value="html">HTML</option>
                                    <option value="pdf">PDF</option>
                                    <option value="excel">Excel</option>
                                    <option value="csv">CSV</option>
                                    <option value="json">JSON</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="includeCharts" class="form-label">Включить графики</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                                    <label class="form-check-label" for="includeCharts">
                                        Добавить визуализации
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheduling -->
                    <div class="mb-3">
                        <h6>Планирование</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleReport">
                            <label class="form-check-label" for="scheduleReport">
                                Запланировать автоматическую генерацию
                            </label>
                        </div>
                        
                        <div id="scheduleOptions" class="mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="scheduleFrequency" class="form-label">Частота</label>
                                    <select class="form-select" id="scheduleFrequency">
                                        <option value="daily">Ежедневно</option>
                                        <option value="weekly">Еженедельно</option>
                                        <option value="monthly">Ежемесячно</option>
                                        <option value="quarterly">Ежеквартально</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="scheduleTime" class="form-label">Время</label>
                                    <input type="time" class="form-control" id="scheduleTime" value="09:00">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="emailNotification" class="form-label">Email уведомления</label>
                                <input type="email" class="form-control" id="emailNotification" placeholder="email@example.com">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="generateReport()">Создать отчет</button>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewReportTitle">Предпросмотр отчета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportPreviewContent">
                <!-- Report preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="exportCurrentReport()">
                    <i class="fas fa-download me-2"></i>
                    Экспорт
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="printReport()">
                    <i class="fas fa-print me-2"></i>
                    Печать
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Reports state
let currentReports = [];
let currentPage = 1;
let totalPages = 1;
let currentPreviewReport = null;

// Report templates
const reportTemplates = [
    {
        id: 'file_overview',
        name: 'Обзор файлов',
        description: 'Общая статистика по всем файлам в системе',
        icon: 'fas fa-file-alt',
        color: 'primary'
    },
    {
        id: 'category_analysis',
        name: 'Анализ категорий',
        description: 'Детальный анализ файлов по категориям',
        icon: 'fas fa-chart-pie',
        color: 'success'
    },
    {
        id: 'size_distribution',
        name: 'Распределение размеров',
        description: 'Анализ распределения файлов по размерам',
        icon: 'fas fa-chart-bar',
        color: 'info'
    },
    {
        id: 'activity_timeline',
        name: 'Временная активность',
        description: 'Анализ активности по времени создания/изменения',
        icon: 'fas fa-chart-line',
        color: 'warning'
    },
    {
        id: 'duplicate_report',
        name: 'Отчет дубликатов',
        description: 'Поиск и анализ дублирующихся файлов',
        icon: 'fas fa-copy',
        color: 'danger'
    },
    {
        id: 'storage_optimization',
        name: 'Оптимизация хранилища',
        description: 'Рекомендации по оптимизации использования места',
        icon: 'fas fa-hdd',
        color: 'dark'
    }
];

// Initialize reports page
document.addEventListener('DOMContentLoaded', function() {
    loadReportStats();
    loadReportTemplates();
    loadReports();
    initializeEventListeners();
});

function initializeEventListeners() {
    // Filter and search
    document.getElementById('reportFilter').addEventListener('change', function() {
        loadReports();
    });
    
    document.getElementById('reportSearch').addEventListener('input', function() {
        filterReports();
    });
    
    // Date range toggle
    document.getElementById('dateRange').addEventListener('change', function() {
        const customRange = document.getElementById('customDateRange');
        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    // Schedule toggle
    document.getElementById('scheduleReport').addEventListener('change', function() {
        const options = document.getElementById('scheduleOptions');
        options.style.display = this.checked ? 'block' : 'none';
    });
}

// Load report statistics
async function loadReportStats() {
    try {
        const response = await apiRequest('/api/reports/stats');
        
        if (response.success) {
            const stats = response.data;
            document.getElementById('totalReports').textContent = stats.total || 0;
            document.getElementById('scheduledReports').textContent = stats.scheduled || 0;
            document.getElementById('recentReports').textContent = stats.recent || 0;
            document.getElementById('exportedReports').textContent = stats.exported || 0;
        }
    } catch (error) {
        console.error('Error loading report stats:', error);
    }
}

// Load report templates
function loadReportTemplates() {
    const container = document.getElementById('reportTemplates');
    
    reportTemplates.forEach(template => {
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 mb-3';
        
        col.innerHTML = `
            <div class="card h-100 template-card" onclick="generateTemplateReport('${template.id}')">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="${template.icon} fa-3x text-${template.color}"></i>
                    </div>
                    <h6 class="card-title">${template.name}</h6>
                    <p class="card-text text-muted small">${template.description}</p>
                    <button class="btn btn-outline-${template.color} btn-sm">
                        <i class="fas fa-play me-1"></i>
                        Создать
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(col);
    });
}

// Load reports list
async function loadReports(page = 1) {
    try {
        showReportsLoading();
        
        const filter = document.getElementById('reportFilter').value;
        const params = new URLSearchParams({
            page: page,
            filter: filter,
            limit: 20
        });
        
        const response = await apiRequest(`/api/reports?${params}`);
        
        if (response.success) {
            currentReports = response.data.reports;
            currentPage = response.data.page;
            totalPages = response.data.totalPages;
            
            renderReports();
            updateReportsPagination();
        } else {
            showAlert('Ошибка загрузки отчетов: ' + response.error, 'danger');
            showReportsEmpty();
        }
    } catch (error) {
        console.error('Error loading reports:', error);
        showAlert('Ошибка загрузки отчетов', 'danger');
        showReportsEmpty();
    } finally {
        hideReportsLoading();
    }
}

// Render reports table
function renderReports() {
    const tbody = document.getElementById('reportsTableBody');
    tbody.innerHTML = '';
    
    if (currentReports.length === 0) {
        showReportsEmpty();
        return;
    }
    
    hideReportsEmpty();
    
    currentReports.forEach(report => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <i class="${getReportIcon(report.type)} me-2 text-${getReportColor(report.type)}"></i>
                    <div>
                        <div class="fw-medium">${report.name}</div>
                        <small class="text-muted">${report.description || ''}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-${getReportColor(report.type)}">${getReportTypeName(report.type)}</span>
            </td>
            <td>
                <span class="badge bg-${getStatusColor(report.status)}">
                    <i class="${getStatusIcon(report.status)} me-1"></i>
                    ${getStatusName(report.status)}
                </span>
            </td>
            <td>${formatDate(report.created)}</td>
            <td>${report.size ? formatFileSize(report.size) : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    ${report.status === 'completed' ? `
                        <button class="btn btn-outline-primary" onclick="previewReport('${report.id}')" title="Предпросмотр">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="downloadReport('${report.id}')" title="Скачать">
                            <i class="fas fa-download"></i>
                        </button>
                    ` : ''}
                    ${report.status === 'scheduled' ? `
                        <button class="btn btn-outline-warning" onclick="editSchedule('${report.id}')" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </button>
                    ` : ''}
                    ${report.status === 'failed' ? `
                        <button class="btn btn-outline-info" onclick="retryReport('${report.id}')" title="Повторить">
                            <i class="fas fa-redo"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-outline-danger" onclick="deleteReport('${report.id}')" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Generate template report
function generateTemplateReport(templateId) {
    const template = reportTemplates.find(t => t.id === templateId);
    if (!template) return;
    
    // Pre-fill form with template data
    document.getElementById('reportName').value = template.name;
    document.getElementById('reportType').value = getTemplateReportType(templateId);
    document.getElementById('reportDescription').value = template.description;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('customReportModal')).show();
}

// Generate custom report
function generateCustomReport() {
    // Clear form
    document.getElementById('customReportForm').reset();
    
    // Load categories for filter
    loadCategoriesForFilter();
    
    // Show modal
    new bootstrap.Modal(document.getElementById('customReportModal')).show();
}

// Load categories for filter
async function loadCategoriesForFilter() {
    try {
        const response = await apiRequest('/api/categories');
        
        if (response.success) {
            const select = document.getElementById('categoryFilter');
            select.innerHTML = '';
            
            response.data.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Generate report
async function generateReport() {
    const form = document.getElementById('customReportForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = {
        name: document.getElementById('reportName').value,
        type: document.getElementById('reportType').value,
        description: document.getElementById('reportDescription').value,
        filters: {
            dateRange: document.getElementById('dateRange').value,
            categories: Array.from(document.getElementById('categoryFilter').selectedOptions).map(o => o.value),
            minSize: document.getElementById('minSize').value,
            maxSize: document.getElementById('maxSize').value,
            pathFilter: document.getElementById('pathFilter').value
        },
        output: {
            format: document.getElementById('outputFormat').value,
            includeCharts: document.getElementById('includeCharts').checked
        },
        schedule: document.getElementById('scheduleReport').checked ? {
            frequency: document.getElementById('scheduleFrequency').value,
            time: document.getElementById('scheduleTime').value,
            email: document.getElementById('emailNotification').value
        } : null
    };
    
    // Add custom date range if selected
    if (formData.filters.dateRange === 'custom') {
        formData.filters.startDate = document.getElementById('startDate').value;
        formData.filters.endDate = document.getElementById('endDate').value;
    }
    
    try {
        const response = await apiRequest('/api/reports/generate', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        if (response.success) {
            showAlert('Отчет успешно создан', 'success');
            bootstrap.Modal.getInstance(document.getElementById('customReportModal')).hide();
            loadReports();
            loadReportStats();
        } else {
            showAlert('Ошибка создания отчета: ' + response.error, 'danger');
        }
    } catch (error) {
        console.error('Error generating report:', error);
        showAlert('Ошибка создания отчета', 'danger');
    }
}

// Preview report
async function previewReport(reportId) {
    try {
        currentPreviewReport = reportId;
        const report = currentReports.find(r => r.id === reportId);
        
        if (!report) return;
        
        document.getElementById('previewReportTitle').textContent = `Предпросмотр: ${report.name}`;
        
        const content = document.getElementById('reportPreviewContent');
        content.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">Загрузка отчета...</p></div>';
        
        const response = await apiRequest(`/api/reports/${reportId}/preview`);
        
        if (response.success) {
            content.innerHTML = response.data.content;
        } else {
            content.innerHTML = `<div class="alert alert-danger">Ошибка загрузки отчета: ${response.error}</div>`;
        }
        
        new bootstrap.Modal(document.getElementById('reportPreviewModal')).show();
    } catch (error) {
        console.error('Error previewing report:', error);
        showAlert('Ошибка предпросмотра отчета', 'danger');
    }
}

// Download report
function downloadReport(reportId) {
    window.open(`/api/reports/${reportId}/download`, '_blank');
}

// Export current report
function exportCurrentReport() {
    if (currentPreviewReport) {
        downloadReport(currentPreviewReport);
    }
}

// Print report
function printReport() {
    const content = document.getElementById('reportPreviewContent').innerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
            <head>
                <title>Отчет</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        .no-print { display: none !important; }
                    }
                </style>
            </head>
            <body>
                <div class="container-fluid">
                    ${content}
                </div>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// Delete report
function deleteReport(reportId) {
    const report = currentReports.find(r => r.id === reportId);
    if (!report) return;
    
    if (confirm(`Вы уверены, что хотите удалить отчет "${report.name}"?`)) {
        // TODO: Implement delete API call
        showAlert('Функция удаления отчета будет реализована в следующей версии', 'info');
    }
}

// Retry failed report
function retryReport(reportId) {
    // TODO: Implement retry API call
    showAlert('Функция повтора генерации будет реализована в следующей версии', 'info');
}

// Edit schedule
function editSchedule(reportId) {
    // TODO: Implement schedule editing
    showAlert('Функция редактирования расписания будет реализована в следующей версии', 'info');
}

// Filter reports
function filterReports() {
    const search = document.getElementById('reportSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#reportsTableBody tr');
    
    rows.forEach(row => {
        const name = row.querySelector('td:first-child .fw-medium').textContent.toLowerCase();
        const description = row.querySelector('td:first-child small').textContent.toLowerCase();
        
        const matches = name.includes(search) || description.includes(search);
        row.style.display = matches ? '' : 'none';
    });
}

// Utility functions
function refreshReports() {
    loadReportStats();
    loadReports(currentPage);
}

function getTemplateReportType(templateId) {
    const typeMap = {
        'file_overview': 'file_analysis',
        'category_analysis': 'category_stats',
        'size_distribution': 'size_analysis',
        'activity_timeline': 'activity_report',
        'duplicate_report': 'duplicate_analysis',
        'storage_optimization': 'custom_query'
    };
    
    return typeMap[templateId] || 'file_analysis';
}

function getReportIcon(type) {
    const iconMap = {
        'file_analysis': 'fas fa-file-alt',
        'category_stats': 'fas fa-chart-pie',
        'size_analysis': 'fas fa-chart-bar',
        'activity_report': 'fas fa-chart-line',
        'duplicate_analysis': 'fas fa-copy',
        'custom_query': 'fas fa-search'
    };
    
    return iconMap[type] || 'fas fa-file';
}

function getReportColor(type) {
    const colorMap = {
        'file_analysis': 'primary',
        'category_stats': 'success',
        'size_analysis': 'info',
        'activity_report': 'warning',
        'duplicate_analysis': 'danger',
        'custom_query': 'dark'
    };
    
    return colorMap[type] || 'secondary';
}

function getReportTypeName(type) {
    const nameMap = {
        'file_analysis': 'Анализ файлов',
        'category_stats': 'Статистика категорий',
        'size_analysis': 'Анализ размеров',
        'activity_report': 'Отчет активности',
        'duplicate_analysis': 'Анализ дубликатов',
        'custom_query': 'Пользовательский'
    };
    
    return nameMap[type] || 'Неизвестный';
}

function getStatusIcon(status) {
    const iconMap = {
        'completed': 'fas fa-check-circle',
        'generating': 'fas fa-spinner fa-spin',
        'scheduled': 'fas fa-clock',
        'failed': 'fas fa-exclamation-triangle'
    };
    
    return iconMap[status] || 'fas fa-question-circle';
}

function getStatusColor(status) {
    const colorMap = {
        'completed': 'success',
        'generating': 'primary',
        'scheduled': 'warning',
        'failed': 'danger'
    };
    
    return colorMap[status] || 'secondary';
}

function getStatusName(status) {
    const nameMap = {
        'completed': 'Готов',
        'generating': 'Генерируется',
        'scheduled': 'Запланирован',
        'failed': 'Ошибка'
    };
    
    return nameMap[status] || 'Неизвестно';
}

function showReportsLoading() {
    document.getElementById('reportsLoading').style.display = 'block';
    document.getElementById('reportsTableBody').style.display = 'none';
    document.getElementById('reportsEmpty').style.display = 'none';
}

function hideReportsLoading() {
    document.getElementById('reportsLoading').style.display = 'none';
    document.getElementById('reportsTableBody').style.display = '';
}

function showReportsEmpty() {
    document.getElementById('reportsEmpty').style.display = 'block';
    document.getElementById('reportsTableBody').style.display = 'none';
}

function hideReportsEmpty() {
    document.getElementById('reportsEmpty').style.display = 'none';
}

function updateReportsPagination() {
    const pagination = document.getElementById('reportsPagination');
    const container = document.getElementById('reportsPaginationContainer');
    
    if (totalPages <= 1) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let html = '';
    
    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadReports(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReports(1)">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadReports(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadReports(${totalPages})">${totalPages}</a></li>`;
    }
    
    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadReports(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    pagination.innerHTML = html;
}
</script>

<style>
.template-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.template-card .card-body {
    padding: 1.5rem;
}

#reportPreviewContent {
    max-height: 70vh;
    overflow-y: auto;
}

.badge {
    font-size: 0.75em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}